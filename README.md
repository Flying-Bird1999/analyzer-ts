# analyzer-ts

`analyzer-ts` 是一个使用 Go 语言编写的高性能命令行工具，旨在深度分析和解析 TypeScript 项目。它提供了一系列强大的功能，可以帮助开发者理解代码结构、优化代码质量、清理无用代码，并对依赖项进行管理。

## 核心功能

- **深度代码分析**: 递归解析整个 TypeScript 项目，构建抽象语法树 (AST)，并提取文件、类、函数、接口、变量、依赖关系等详细信息。
- **依赖关系检查**: 类似于 `npm-check`，该工具可以识别项目中潜在的依赖问题，包括：
  - **隐式依赖 (幽灵依赖)**: 在代码中被使用，但未在 `package.json` 中声明的依赖。
  - **未使用依赖**: 在 `package.json` 中已声明，但在代码中从未被引用的依赖。
  - **过期依赖**: `package.json` 中版本落后于最新版本的依赖。
- **代码健康度检查**:
  - **查找未引用文件**: 识别项目中从未被任何其他文件导入或引用的“孤岛”文件，帮助清理废弃代码。
  - **查找未使用导出**: 识别在模块中已导出 (export)，但从未在项目其他地方被导入 (import) 的变量、函数、类或类型。
- **调用链分析**: 追踪一个或多个函数或模块的上游调用关系，帮助理解代码的逻辑流和依赖关系。
- **数据库存储**: 将完整的分析结果（包括文件、依赖、代码节点等）存储在 SQLite 数据库的宽表中，便于进行复杂查询和历史数据分析。
- **类型打包**: 从指定的入口文件开始，递归地收集所有相关的 TypeScript 类型声明，并将它们打包到一个单独的 `.d.ts` 文件中。

## 工作原理

`analyzer-ts` 的核心是一个用 Go 编写的 TypeScript 解析器。它会遍历项目目录下的所有 `.ts` 和 `.tsx` 文件，并为每个文件生成一个抽象语法树 (AST)。通过分析这些 AST，该工具能够提取出详细的代码结构信息，并构建出整个项目的依赖图。基于这些数据，它能够执行上述的各项分析任务。

## 安装

1. **确保您已经安装了 Go (1.18 或更高版本)。**
2. **克隆此仓库:**

   ```bash
   git clone https://github.com/your-username/analyzer-ts.git
   ```
3. **进入项目目录:**

   ```bash
   cd analyzer-ts
   ```
4. **构建项目:**

   ```bash
   go build -o analyzer-ts
   ```

   我们推荐使用 `-o` 标志来指定输出文件的名称。此命令会编译源代码，并在项目根目录下生成一个名为 `analyzer-ts` (在 Windows 上是 `analyzer-ts.exe`) 的可执行文件。

## 命令

所有命令都通过主程序 `analyzer-ts` 执行。您可以通过 `--help` 标志查看所有可用命令和它们的选项。

---

### `analyze`

分析一个 TypeScript 项目，并将每个文件的详细分析结果（包括 AST 和元数据）输出为单独的 JSON 文件。

**用法:**

```bash
./analyzer-ts analyze -i <项目路径> -o <输出目录> [选项]
```

**参数:**

| 标志           | 简写   | 描述                                                  | 是否必需 |
| -------------- | ------ | ----------------------------------------------------- | -------- |
| `--input`    | `-i` | 要分析的 TypeScript 项目的根目录路径。                | 是       |
| `--output`   | `-o` | 用于存储生成的 JSON 文件的目录路径。                  | 是       |
| `--exclude`  | `-x` | 要从分析中排除的文件或目录的 Glob 模式。可多次使用。  | 否       |
| `--monorepo` | `-m` | 如果要分析的是一个 monorepo 项目，请设置为 `true`。 | 否       |

**示例:**

```bash
# 分析一个标准项目，并排除 node_modules 和测试文件
./analyzer-ts analyze \
  -i /path/to/my-project \
  -o /path/to/output/results \
  -x "node_modules/**" \
  -x "**/*.test.ts"
```

**输出:**
该命令会在指定的输出目录中为每个被分析的文件生成一个对应的 `.json` 文件，其中包含了该文件的详细 AST 结构和元数据。

---

### `npm-check`

检查项目的 NPM 依赖，识别隐式依赖、未使用依赖和过期依赖。

**用法:**

```bash
./analyzer-ts npm-check -i <项目路径> [选项]
```

**参数:**

| 标志           | 简写   | 描述                                                               | 是否必需 |
| -------------- | ------ | ------------------------------------------------------------------ | -------- |
| `--input`    | `-i` | 要分析的 TypeScript 项目的根目录路径。                             | 是       |
| `--output`   | `-o` | 将结果输出为 JSON 文件的目录路径。如果未提供，则在控制台打印摘要。 | 否       |
| `--exclude`  | `-x` | 要从分析中排除的文件或目录的 Glob 模式。可多次使用。               | 否       |
| `--monorepo` | `-m` | 如果要分析的是一个 monorepo 项目，请设置为 `true`。              | 否       |

**示例:**

```bash
# 检查依赖并在控制台输出结果
./analyzer-ts npm-check -i /path/to/my-project

# 检查依赖并将结果保存为 JSON 文件
./analyzer-ts npm-check -i /path/to/my-project -o /path/to/output/results
```

**输出:**

- **控制台输出**: 在标准输出中打印易于阅读的摘要，列出所有发现的依赖问题。
- **JSON 文件**: 生成一个 JSON 文件，其中包含所有已识别的隐式、未使用和过期依赖的详细列表。

---

### `find-unreferenced-files`

在项目中查找所有从未被任何其他文件导入或引用的文件。

**用法:**

```bash
./analyzer-ts find-unreferenced-files -i <项目路径> [选项]
```

**参数:**

| 标志                     | 简写   | 描述                                                               | 是否必需 |
| ------------------------ | ------ | ------------------------------------------------------------------ | -------- |
| `--input`              | `-i` | 要分析的 TypeScript 项目的根目录路径。                             | 是       |
| `--output`             | `-o` | 将结果输出为 JSON 文件的目录路径。如果未提供，则在控制台打印摘要。 | 否       |
| `--exclude`            | `-x` | 要从分析中排除的文件或目录的 Glob 模式。可多次使用。               | 否       |
| `--monorepo`           | `-m` | 如果要分析的是一个 monorepo 项目，请设置为 `true`。              | 否       |
| `--entrypoints`        | `-e` | 指定一个或多个入口文件。这些文件将被视为“已引用”。可多次使用。   | 否       |
| `--include-entry-dirs` |        | 自动包含常见的入口目录文件（如 `src/index.ts`）。                | 否       |

**示例:**

```bash
# 查找所有未被引用的文件
./analyzer-ts find-unreferenced-files -i /path/to/my-project -o /path/to/output/results
```

**输出:**
生成一个 JSON 文件，其中包含一个数组，列出了所有未被引用的文件的完整路径。

---

### `find-unconsumed-exports`

查找项目中所有已导出但从未在别处被导入的变量、函数、类或类型。

**用法:**

```bash
./analyzer-ts find-unconsumed-exports -i <项目路径> [选项]
```

**参数:**

| 标志           | 简写   | 描述                                                               | 是否必需 |
| -------------- | ------ | ------------------------------------------------------------------ | -------- |
| `--input`    | `-i` | 要分析的 TypeScript 项目的根目录路径。                             | 是       |
| `--output`   | `-o` | 将结果输出为 JSON 文件的目录路径。如果未提供，则在控制台打印摘要。 | 否       |
| `--exclude`  | `-x` | 要从分析中排除的文件或目录的 Glob 模式。可多次使用。               | 否       |
| `--monorepo` | `-m` | 如果要分析的是一个 monorepo 项目，请设置为 `true`。              | 否       |

**示例:**

```bash
# 查找未使用的导出项，并在控制台显示结果
./analyzer-ts find-unconsumed-exports -i /path/to/my-project
```

**输出:**

- **控制台输出**: 打印一份摘要，包括扫描的文件总数、发现的导出总数以及未使用的导出项列表。
- **JSON 文件**: 生成一个 JSON 文件，其中包含所有未使用导出项的详细信息（名称、类型、文件路径和行号）。

---

### `find-callers`

查找一个或多个指定文件的所有上游调用方。

**用法:**

```bash
./analyzer-ts find-callers -i <项目路径> -f <目标文件> [选项]
```

**参数:**

| 标志           | 简写   | 描述                                                               | 是否必需 |
| -------------- | ------ | ------------------------------------------------------------------ | -------- |
| `--input`    | `-i` | 要分析的 TypeScript 项目的根目录路径。                             | 是       |
| `--file`     | `-f` | 要追踪其调用链的目标文件路径。可多次使用以指定多个文件。           | 是       |
| `--output`   | `-o` | 将结果输出为 JSON 文件的目录路径。如果未提供，则在控制台打印摘要。 | 否       |
| `--exclude`  | `-x` | 要从分析中排除的文件或目录的 Glob 模式。可多次使用。               | 否       |
| `--monorepo` | `-m` | 如果要分析的是一个 monorepo 项目，请设置为 `true`。              | 否       |

**示例:**

```bash
# 查找单个文件的调用链
./analyzer-ts find-callers -i /path/to/my-project -f /path/to/my-project/src/utils.ts -o /path/to/output/results
```

**输出:**
生成一个 JSON 文件，其中包含一个详细的调用图，显示了从入口点到目标文件的所有调用路径。

---

### `store-db`

分析 TypeScript 项目并将完整的分析结果存储在一个 SQLite 数据库文件中。

**用法:**

```bash
./analyzer-ts store-db -i <项目路径> -o <输出目录> [选项]
```

**参数:**

| 标志           | 简写   | 描述                                                  | 是否必需 |
| -------------- | ------ | ----------------------------------------------------- | -------- |
| `--input`    | `-i` | 要分析的 TypeScript 项目的根目录路径。                | 是       |
| `--output`   | `-o` | 用于存储生成的 SQLite 数据库文件的目录路径。          | 是       |
| `--exclude`  | `-x` | 要从分析中排除的文件或目录的 Glob 模式。可多次使用。  | 否       |
| `--monorepo` | `-m` | 如果要分析的是一个 monorepo 项目，请设置为 `true`。 | 否       |

**示例:**

```bash
# 分析项目并将结果存入数据库
./analyzer-ts store-db -i /path/to/my-project -o /path/to/output/db
```

**输出:**
在指定的输出目录中创建一个名为 `<项目名>_store_db.db` 的 SQLite 数据库文件。该文件包含了多个表，分别存储了 `package.json` 信息、文件列表、导入、导出、接口、函数调用和变量等所有分析数据。

---

### `bundle`

从给定的入口文件递归收集所有引用的类型声明，并将它们打包到一个单独的文件中。

**用法:**

```bash
./analyzer-ts bundle -i <入口文件> -t <类型名称> [选项]
```

**参数:**

| 标志         | 简写   | 描述                                     | 是否必需 |
| ------------ | ------ | ---------------------------------------- | -------- |
| `--input`  | `-i` | 入口文件的路径。                         | 是       |
| `--type`   | `-t` | 要分析的根类型名称。                     | 是       |
| `--output` | `-o` | 输出文件的路径。默认为 `./output.ts`。 | 否       |
| `--root`   | `-r` | 项目的根路径。                           | 否       |

**示例:**

```bash
# 将 MyClass 类型及其所有依赖的类型打包
./analyzer-ts bundle -i ./src/index.ts -t MyClass -o ./dist/types.d.ts
```

**输出:**
在指定的输出路径生成一个 `.ts` (或 `.d.ts`) 文件，其中包含了指定类型及其所有依赖类型的声明。

## 项目结构

- **`analyzer/`**: 包含核心的 TypeScript 解析器和分析器逻辑。
- **`analyzer_plugin/`**: 包含基于核心分析器构建的各种插件和命令。
- **`cmd/`**: 包含使用 `cobra` 库定义的命令行界面。
- **`main.go`**: 项目的入口点。
