package unreferenced

import (
	"fmt"
	"strings"

	projectanalyzer "github.com/Flying-Bird1999/analyzer-ts/analyzer_plugin/project_analyzer"
)

// FindUnreferencedFilesResult ä¿å­˜äº†"æœªå¼•ç”¨æ–‡ä»¶"åˆ†æçš„å®Œæ•´ç»“æœã€‚
// å®ƒå®ç°äº† projectanalyzer.Result æ¥å£ã€‚
//
// è®¾è®¡ç†å¿µï¼š
// è¯¥ç»“æœç»“æ„ä½“é‡‡ç”¨åˆ†å±‚çš„è®¾è®¡ï¼ŒåŒ…å«é…ç½®ä¿¡æ¯ã€ç»Ÿè®¡æ•°æ®ã€
// å’Œåˆ†ç±»çš„æ–‡ä»¶åˆ—è¡¨ã€‚è¿™ç§è®¾è®¡æ—¢æä¾›å¿«é€Ÿæ¦‚è§ˆï¼Œä¹Ÿæ”¯æŒè¯¦ç»†åˆ†æã€‚
//
// æ•°æ®ç»„ç»‡ï¼š
// - Configuration: åˆ†æé…ç½®ä¿¡æ¯ï¼Œç¡®ä¿ç»“æœçš„å¯è¿½æº¯æ€§
// - Stats: é‡åŒ–ç»Ÿè®¡æ•°æ®ï¼Œæä¾›æ•´ä½“åˆ†ææ¦‚å†µ
// - EntrypointFiles: å…¥å£æ–‡ä»¶åˆ—è¡¨ï¼Œç”¨äºåˆ†æéªŒè¯
// - SuspiciousFiles: éœ€è¦äººå·¥æ£€æŸ¥çš„å¯ç–‘æ–‡ä»¶
// - TrulyUnreferencedFiles: å¯ä»¥å®‰å…¨åˆ é™¤çš„çœŸæ­£æœªå¼•ç”¨æ–‡ä»¶
//
// åˆ†ç±»ç­–ç•¥ï¼š
// æ™ºèƒ½åˆ†ç±»æœºåˆ¶å°†æœªå¼•ç”¨æ–‡ä»¶åˆ†ä¸ºä¸¤ç±»ï¼š
// 1. å¯ç–‘æ–‡ä»¶ï¼šå¯èƒ½è¢«é—´æ¥ä½¿ç”¨æˆ–å…·æœ‰ç‰¹æ®Šç”¨é€”çš„æ–‡ä»¶
// 2. çœŸæ­£æœªå¼•ç”¨æ–‡ä»¶ï¼šå¯ä»¥å®‰å…¨åˆ é™¤çš„æ­»ä»£ç æ–‡ä»¶
//
// è¾“å‡ºæ ¼å¼ï¼š
// - æ§åˆ¶å°ï¼šäººç±»å¯è¯»çš„åˆ†ç±»æŠ¥å‘Šï¼ŒåŒ…å«æ–‡ä»¶è·¯å¾„åˆ—è¡¨
// - JSONï¼šæœºå™¨å¯è¯»çš„ç»“æ„åŒ–æ•°æ®ï¼Œä¾¿äºé›†æˆå’Œè‡ªåŠ¨åŒ–å¤„ç†
type FindUnreferencedFilesResult struct {
	// Configuration è®°å½•äº†æœ¬æ¬¡åˆ†ææ‰€ä½¿ç”¨çš„é…ç½®å‚æ•°ã€‚
	// è¿™äº›ä¿¡æ¯å¯¹äºç»“æœçš„å¯è¿½æº¯æ€§å’Œåˆ†æé‡ç°éå¸¸é‡è¦ã€‚
	Configuration AnalysisConfiguration `json:"configuration"`

	// Stats åŒ…å«äº†æœ¬æ¬¡åˆ†æçš„å„é¡¹ç»Ÿè®¡æ•°æ®ã€‚
	// æä¾›åˆ†æè¿‡ç¨‹çš„é‡åŒ–æŒ‡æ ‡ï¼Œç”¨äºå¿«é€Ÿè¯„ä¼°é¡¹ç›®çŠ¶å†µã€‚
	Stats SummaryStats `json:"stats"`

	// EntrypointFiles æ˜¯åœ¨æœ¬æ¬¡åˆ†æä¸­è¢«å½“ä½œå…¥å£ç‚¹çš„æ–‡ä»¶åˆ—è¡¨ã€‚
	// è¿™äº›æ–‡ä»¶æ˜¯æ·±åº¦ä¼˜å…ˆæœç´¢çš„èµ·å§‹ç‚¹ï¼Œç”¨äºè¯†åˆ«æ‰€æœ‰å¯è¾¾æ–‡ä»¶ã€‚
	EntrypointFiles []string `json:"entrypointFiles"`

	// SuspiciousFiles æ˜¯ä¸€äº›è™½ç„¶æœªè¢«ç›´æ¥å¼•ç”¨ï¼Œä½†æ ¹æ®å…¶å‘½åæˆ–ä½ç½®ï¼Œå¯èƒ½å¾ˆé‡è¦çš„æ–‡ä»¶ã€‚
	// è¿™äº›æ–‡ä»¶éœ€è¦äººå·¥æ£€æŸ¥ç¡®è®¤ï¼Œä¾‹å¦‚é…ç½®æ–‡ä»¶ã€å…¥å£æ–‡ä»¶ã€æ ¸å¿ƒæ¨¡å—ç­‰ã€‚
	SuspiciousFiles []string `json:"suspiciousFiles"`

	// TrulyUnreferencedFiles æ˜¯è¢«è®¤ä¸ºæ˜¯"çœŸæ­£"æœªè¢«å¼•ç”¨çš„æ–‡ä»¶åˆ—è¡¨ã€‚
	// è¿™äº›æ–‡ä»¶å¯ä»¥ç›¸å¯¹å®‰å…¨åœ°åˆ é™¤ï¼Œä½†å»ºè®®åœ¨åˆ é™¤å‰è¿›è¡Œäººå·¥ç¡®è®¤ã€‚
	TrulyUnreferencedFiles []string `json:"trulyUnreferencedFiles"`
}

// ç¡®ä¿ FindUnreferencedFilesResult ç»“æ„ä½“å®ç°äº† projectanalyzer.Result æ¥å£ã€‚
// è¿™æ˜¯ä¸€ä¸ªç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œç¡®ä¿ç»“æ„ä½“æ»¡è¶³æ¥å£è¦æ±‚ã€‚
var _ projectanalyzer.Result = (*FindUnreferencedFilesResult)(nil)

// Name è¿”å›è¯¥ç»“æœå¯¹åº”çš„åˆ†æå™¨çš„åç§°ã€‚
//
// è¿”å›å€¼è¯´æ˜ï¼š
// è¿”å› "Find Unreferenced Files" ä½œä¸ºåˆ†æå™¨çš„æ ‡è¯†ç¬¦ã€‚
// è¿™ä¸ªåç§°ç”¨äºåœ¨ç»“æœè¾“å‡ºä¸­æ ‡è¯†è¯¥åˆ†æå™¨çš„åˆ†æç»“æœã€‚
func (r *FindUnreferencedFilesResult) Name() string {
	return "Find Unreferenced Files"
}

// Summary è¿”å›å¯¹ç»“æœçš„ç®€çŸ­ã€äººç±»å¯è¯»çš„æ‘˜è¦ã€‚
//
// è®¾è®¡ç›®çš„ï¼š
// è¯¥æ–¹æ³•æä¾›å¿«é€Ÿæ¦‚è§ˆä¿¡æ¯ï¼Œé€‚ç”¨äºï¼š
// - æ§åˆ¶å°è¾“å‡ºçš„é¦–è¡Œæ‘˜è¦
// - æ—¥å¿—è®°å½•å’Œç›‘æ§
// - CI/CD çŠ¶æ€æŠ¥å‘Š
// - å¿«é€Ÿåˆ¤æ–­åˆ†æç»“æœçŠ¶æ€
//
// è¾“å‡ºæ ¼å¼ï¼š
// é‡‡ç”¨ä¸­æ–‡å‹å¥½çš„æ ¼å¼ï¼Œæ¸…æ™°æ˜¾ç¤ºæ‰«ææ–‡ä»¶æ•°é‡å’Œå„ç±»æœªå¼•ç”¨æ–‡ä»¶æ•°é‡ã€‚
//
// è¿”å›å€¼è¯´æ˜ï¼š
// è¿”å›åŒ…å«å…³é”®ç»Ÿè®¡ä¿¡æ¯çš„å­—ç¬¦ä¸²ï¼Œæ ¼å¼ä¸ºï¼š
// "æ‰«ææ–‡ä»¶ X ä¸ªï¼Œå‘ç° Y ä¸ªçœŸæ­£æœªå¼•ç”¨æ–‡ä»¶å’Œ Z ä¸ªå¯ç–‘æ–‡ä»¶ã€‚"
func (r *FindUnreferencedFilesResult) Summary() string {
	return fmt.Sprintf(
		"æ‰«ææ–‡ä»¶ %d ä¸ªï¼Œå‘ç° %d ä¸ªçœŸæ­£æœªå¼•ç”¨æ–‡ä»¶å’Œ %d ä¸ªå¯ç–‘æ–‡ä»¶ã€‚",
		r.Stats.TotalFiles,
		r.Stats.TrulyUnreferencedFiles,
		r.Stats.SuspiciousFiles,
	)
}

// ToJSON å°†ç»“æœçš„å®Œæ•´æ•°æ®åºåˆ—åŒ–ä¸º JSON æ ¼å¼ã€‚
//
// åŠŸèƒ½è¯´æ˜ï¼š
// è¯¥æ–¹æ³•å°†å®Œæ•´çš„åˆ†æç»“æœåºåˆ—åŒ–ä¸º JSON æ ¼å¼ï¼Œæ”¯æŒï¼š
// - æœºå™¨å¯è¯»çš„ç»“æ„åŒ–æ•°æ®è¾“å‡º
// - é›†æˆåˆ° CI/CD æµç¨‹
// - æ•°æ®åº“å­˜å‚¨å’Œåç»­åˆ†æ
// - è‡ªåŠ¨åŒ–æŠ¥å‘Šç”Ÿæˆ
//
// å‚æ•°è¯´æ˜ï¼š
// - indent: æ§åˆ¶æ˜¯å¦æ ¼å¼åŒ– JSON è¾“å‡ºï¼Œtrue ä¸ºæ ¼å¼åŒ–è¾“å‡ºï¼Œfalse ä¸ºç´§å‡‘è¾“å‡º
//
// è¿”å›å€¼è¯´æ˜ï¼š
// - []byte: JSON æ ¼å¼çš„ç»“æœæ•°æ®
// - error: åºåˆ—åŒ–è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„é”™è¯¯
func (r *FindUnreferencedFilesResult) ToJSON(indent bool) ([]byte, error) {
	return projectanalyzer.ToJSONBytes(r, indent)
}

// ToConsole å°†ç»“æœæ ¼å¼åŒ–ä¸ºé€‚åˆåœ¨æ§åˆ¶å°ï¼ˆç»ˆç«¯ï¼‰ä¸­æ‰“å°çš„å­—ç¬¦ä¸²ã€‚
//
// è¾“å‡ºè®¾è®¡ï¼š
// é‡‡ç”¨æ¸…æ™°çš„åˆ†ç±»ç»“æ„ï¼Œä½¿ç”¨è¡¨æƒ…ç¬¦å·å’Œåˆ†éš”çº¿å¢å¼ºå¯è¯»æ€§ï¼š
// - âœ… æ— æœªå¼•ç”¨æ–‡ä»¶ï¼šæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
// - âš ï¸ å‘ç°æœªå¼•ç”¨æ–‡ä»¶ï¼šæ˜¾ç¤ºè­¦å‘Šæ¶ˆæ¯å’Œè¯¦ç»†åˆ†ç±»
// - ğŸ—‘ï¸ çœŸæ­£æœªå¼•ç”¨æ–‡ä»¶ï¼šæ ‡è®°ä¸ºå¯å®‰å…¨åˆ é™¤
// - ğŸ¤” å¯ç–‘æ–‡ä»¶ï¼šæ ‡è®°ä¸ºéœ€è¦äººå·¥æ£€æŸ¥
//
// åˆ†ç±»æ˜¾ç¤ºï¼š
// å¯¹äºæ¯ç±»æ–‡ä»¶ï¼Œæ˜¾ç¤ºæ–‡ä»¶è·¯å¾„åˆ—è¡¨ï¼Œä¾¿äºå¿«é€Ÿå®šä½å’Œæ£€æŸ¥ã€‚
// åˆ†ç±»çš„æ˜¾ç¤ºé¡ºåºæŒ‰ç…§å¤„ç†ä¼˜å…ˆçº§æ’åˆ—ã€‚
//
// ä½¿ç”¨åœºæ™¯ï¼š
// - å‘½ä»¤è¡Œå·¥å…·çš„ç›´æ¥è¾“å‡º
// - å¼€å‘è€…å¿«é€Ÿè¯†åˆ«å¯åˆ é™¤çš„æ–‡ä»¶
// - ä»£ç å®¡æŸ¥ä¼šè®®çš„è®¨è®ºææ–™
// - é¡¹ç›®ç»´æŠ¤å·¥ä½œçš„å‚è€ƒä¾æ®
func (r *FindUnreferencedFilesResult) ToConsole() string {
	totalUnreferenced := len(r.TrulyUnreferencedFiles) + len(r.SuspiciousFiles)

	// å¤„ç†æ²¡æœ‰æœªå¼•ç”¨æ–‡ä»¶çš„æƒ…å†µ
	if totalUnreferenced == 0 {
		return fmt.Sprintf("âœ… %s æ²¡æœ‰å‘ç°ä»»ä½•æœªå¼•ç”¨æ–‡ä»¶ã€‚", r.Summary())
	}

	// æ„å»ºåŒ…å«è¯¦ç»†åˆ†ç±»ä¿¡æ¯çš„è¾“å‡º
	var builder strings.Builder
	builder.WriteString(fmt.Sprintf("âš ï¸ %s\n", r.Summary()))

	// æ˜¾ç¤ºçœŸæ­£æœªå¼•ç”¨çš„æ–‡ä»¶
	if len(r.TrulyUnreferencedFiles) > 0 {
		builder.WriteString("\n--- ğŸ—‘ï¸ çœŸæ­£æœªå¼•ç”¨çš„æ–‡ä»¶ (å¯ä»¥å®‰å…¨åˆ é™¤) ---\n")
		for _, file := range r.TrulyUnreferencedFiles {
			builder.WriteString(fmt.Sprintf("  - %s\n", file))
		}
	}

	// æ˜¾ç¤ºå¯ç–‘çš„æœªå¼•ç”¨æ–‡ä»¶
	if len(r.SuspiciousFiles) > 0 {
		builder.WriteString("\n--- ğŸ¤” å¯ç–‘çš„æœªå¼•ç”¨æ–‡ä»¶ (è¯·äººå·¥æ£€æŸ¥) ---\n")
		for _, file := range r.SuspiciousFiles {
			builder.WriteString(fmt.Sprintf("  - %s\n", file))
		}
	}

	return builder.String()
}
